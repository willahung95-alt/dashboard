<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow">
  <title>ç¶²ç«™æœå‹™ç›£æ§ä¸­å¿ƒ</title>
  <style>
    /* --- åŸºç¤è¨­å®š --- */
    :root {
      --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #111827;
      --text-sub: #6b7280; --border: #e5e7eb; --primary: #2563eb;
      --success-bg: #d1fae5; --success-text: #065f46;
      --danger-bg: #fee2e2; --danger-text: #991b1b;
      --unknown-bg: #f3f4f6; --unknown-text: #374151;
    }

    body {
      display: none; /* é©—è­‰å‰éš±è—ï¼Œé¿å…é–ƒçˆ */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; min-height: 100vh;
    }

    /* --- ç‰ˆé¢é…ç½® --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    h1 { margin: 0; font-size: 24px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 10px; }
    h1::before { content: ''; display: block; width: 6px; height: 24px; background: var(--primary); border-radius: 4px; }
    .last-update { font-size: 13px; color: var(--text-sub); background: #fff; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }

    /* --- ç‹€æ…‹æ¦‚è¦½å¡ç‰‡ --- */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); display: flex; flex-direction: column; }
    .card-label { font-size: 14px; color: var(--text-sub); margin-bottom: 8px; }
    .card-value { font-size: 32px; font-weight: 700; color: var(--text-main); }
    .card.up-card { border-left: 4px solid #10b981; }
    .card.down-card { border-left: 4px solid #ef4444; }
    .card.total-card { border-left: 4px solid #6366f1; }

    /* --- å·¥å…·åˆ— --- */
    .toolbar { display: flex; gap: 12px; margin-bottom: 16px; }
    .search-input { flex: 1; padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .btn-refresh { padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-sub); transition: all 0.2s; }
    .btn-refresh:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }

    /* --- è¡¨æ ¼æ¨£å¼ --- */
    .table-container { background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); overflow-x: auto; padding-bottom: 50px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    thead { background: #f9fafb; border-bottom: 1px solid var(--border); }
    th { text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
    td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; vertical-align: middle; }
    tr:hover { background-color: #f9fafb; }

    /* --- ç‹€æ…‹æ¨™ç±¤ --- */
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }
    .badge.up { background: var(--success-bg); color: var(--success-text); }
    .badge.down { background: var(--danger-bg); color: var(--danger-text); }
    .badge.unknown { background: var(--unknown-bg); color: var(--unknown-text); }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background-color: currentColor; }

    a.link { color: var(--primary); text-decoration: none; font-weight: 500; }
    .text-sm { font-size: 12px; color: var(--text-sub); }
    .text-code { font-family: monospace; font-size: 13px; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }

    /* --- Popover éŒ¯èª¤è©³ç´°è³‡è¨Š --- */
    td.col-reason { position: relative; text-align: center; }
    .error-details { display: inline-block; }
    .error-details summary { list-style: none; cursor: pointer; }
    .btn-info-toggle { font-size: 18px; color: var(--danger-text); background: var(--danger-bg); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
    .error-popover { position: absolute; right: 10px; top: 50px; z-index: 999; width: 280px; background: #fff; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: left; animation: popIn 0.2s ease-out; }
    @keyframes popIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .popover-title { font-weight: 700; font-size: 14px; margin-bottom: 8px; color: var(--danger-text); }
    .err-msg-full { font-size: 13px; line-height: 1.6; color: #374151; word-break: break-word; }

    /* --- Loading --- */
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px); transition: opacity 0.3s; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Forbidden é é¢ */
    .forbidden-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; font-family: sans-serif; text-align: center; }
  </style>
</head>
<body>

  <div id="loader" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="container" id="main-content">
    <header>
      <h1>ç¶²ç«™æœå‹™ç›£æ§ä¸­å¿ƒ</h1>
      <div class="last-update" id="lastUpdateDisplay">
        <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%; box-shadow:0 0 4px #10b981;"></span>
        ç­‰å¾…åŒæ­¥ä¸­...
      </div>
    </header>

    <div class="dashboard-grid">
      <div class="card total-card">
        <div class="card-label">ç›£æ§ç¸½æ•¸</div>
        <div class="card-value" id="val-total">-</div>
      </div>
      <div class="card up-card">
        <div class="card-label">æœå‹™æ­£å¸¸ (UP)</div>
        <div class="card-value" style="color: #059669;" id="val-up">-</div>
      </div>
      <div class="card down-card">
        <div class="card-label">æœå‹™ç•°å¸¸ (DOWN)</div>
        <div class="card-value" style="color: #dc2626;" id="val-down">-</div>
      </div>
    </div>

    <div class="toolbar">
      <input id="q" class="search-input" placeholder="ğŸ” æœå°‹å®¢æˆ¶åç¨±æˆ–ç¶²å€..." />
      <button id="refresh" class="btn-refresh">âŸ³ é‡æ–°æ•´ç†</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">ç³»çµ±ç‹€æ…‹</th>
            <th style="width:280px;">å®¢æˆ¶åç¨±</th>
            <th>ç¶²å€é€£çµ</th>
            <th style="width:100px;">HTTP</th>
            <th style="width:100px;">å»¶é²</th>
            <th style="width:180px;">æœ€å¾Œæª¢æŸ¥</th>
            <th style="width:90px; text-align:center;">ç‹€æ…‹èªªæ˜</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ======= è¨­å®šå€ =======
    const ALLOW_IP = "59.125.131.181";
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxZsTFYOsMhRuStkKOM_IOui4suN2jXsQYWIObka0mnRVynuscYHj1Z-0bv9_vJTntm/exec"; 
    const TOKEN = "v1_2c8c6f3a8c1d4f11b7f5a9c0d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0";

    const $ = (id) => document.getElementById(id);
    let allItems = [];
    let userIp = "";

    // ======= 1. IP é©—è­‰é‚è¼¯ =======
    async function checkAccess() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIp = data.ip;

        if (userIp === ALLOW_IP) {
          // IP ç¬¦åˆï¼šé¡¯ç¤ºä¸»é é¢ä¸¦è¼‰å…¥æ•¸æ“š
          document.body.style.display = "block";
          initApp();
        } else {
          // IP ä¸ç¬¦ï¼šé¡¯ç¤ºæ‹’çµ•é é¢
          showForbidden(userIp);
        }
      } catch (e) {
        showForbidden("ç„¡æ³•å–å¾—é€£ç·šè³‡è¨Š");
      }
    }

    function showForbidden(ip) {
      document.body.innerHTML = `
        <div class="forbidden-container">
          <h1 style="font-size: 80px; color: #dc2626; margin: 0;">403</h1>
          <h2 style="margin: 10px 0;">å­˜å–é­æ‹’ (Forbidden)</h2>
          <p style="color: #666; font-size: 18px;">æ‚¨çš„ IP ä½å€ <b>${ip}</b> æœªç²æˆæ¬Šã€‚</p>
          <p style="font-size: 14px; color: #999;">è«‹åˆ‡æ›è‡³å…¬å¸ç¶²è·¯ç’°å¢ƒè§€çœ‹ã€‚</p>
        </div>`;
      document.body.style.display = "block";
    }

    function initApp() {
      load();
      setInterval(load, 60 * 1000); // è‡ªå‹•åˆ·æ–°
    }

    // ======= 2. æ•¸æ“šè™•ç† =======
    async function load() {
      if(allItems.length === 0) $("loader").classList.remove("hidden");
      $("lastUpdateDisplay").innerHTML = `âŸ³ æ›´æ–°ä¸­...`;
      
      try {
        const url = `${GAS_WEB_APP_URL}?token=${encodeURIComponent(TOKEN)}&client_ip=${encodeURIComponent(userIp)}`;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        
        if (!data.ok) { 
          alert(`å¾Œç«¯æ‹’çµ•å­˜å–ï¼š${data.error || "unknown"}`); 
          return; 
        }
        
        allItems = data.items || [];
        render(allItems);
        
        const now = new Date();
        $("lastUpdateDisplay").innerHTML = `<span style="color:#059669">âœ”</span> æœ€å¾Œæ›´æ–°ï¼š${now.toLocaleTimeString('zh-TW', { hour12: false })}`;
      } catch(e) {
        console.error(e);
        $("lastUpdateDisplay").innerHTML = `<span style="color:#dc2626">âœ–</span> åŒæ­¥å¤±æ•—`;
      } finally {
        $("loader").classList.add("hidden");
      }
    }

    function render(items) {
      const q = ($("q").value || "").trim().toLowerCase();
      const filtered = items.filter(it => {
        if (!q) return true;
        return (it.customer || "").toLowerCase().includes(q) || (it.url || "").toLowerCase().includes(q);
      });

      const tbody = $("tbody");
      tbody.innerHTML = "";

      if(filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color:#999;">æŸ¥ç„¡ç›¸é—œè³‡æ–™</td></tr>`;
      }

      filtered.forEach((it, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${getBadgeHtml(it.status)}</td>
          <td style="font-weight:600;">${it.customer || "(æœªå‘½å)"}</td>
          <td><a href="${it.url}" class="link" target="_blank" rel="noopener noreferrer">${it.url}</a></td>
          <td>${it.httpCode ? `<span class="text-code">${it.httpCode}</span>` : "-"}</td>
          <td class="text-sm">${it.latencyMs ? `${it.latencyMs} ms` : "-"}</td>
          <td class="text-sm">${it.checkedAt || ""}</td>
          <td class="col-reason">
            ${it.status === "DOWN" ? `
              <details class="error-details">
                <summary class="btn-info-toggle">â„¹ï¸</summary>
                <div class="error-popover">
                  <div class="popover-title">âš ï¸ ç•°å¸¸è©³ç´°è³‡è¨Š</div>
                  <div class="err-msg-full">${getReadableReason(it.reason)}</div>
                </div>
              </details>
            ` : `<span class="text-sm" style="color:#9ca3af">OK</span>`}
          </td>
        `;
        tbody.appendChild(tr);
      });

      updateStats(filtered);
    }

    function getBadgeHtml(status) {
      if (status === "UP") return `<span class="badge up"><span class="badge-dot"></span>æ­£å¸¸é‹ä½œ</span>`;
      if (status === "DOWN") return `<span class="badge down"><span class="badge-dot"></span>ç•°å¸¸ä¸­æ–·</span>`;
      return `<span class="badge unknown"><span class="badge-dot"></span>æª¢æŸ¥ä¸­</span>`;
    }

    function updateStats(items) {
      const up = items.filter(x => x.status === "UP").length;
      const down = items.filter(x => x.status === "DOWN").length;
      $("val-total").textContent = items.length;
      $("val-up").textContent = up;
      $("val-down").textContent = down;
    }

    // ======= æ–°å¢ï¼šéŒ¯èª¤åŸå› ç¿»è­¯å‡½æ•¸ =======
    function getReadableReason(reason) {
      if (!reason) return "æœªçŸ¥éŒ¯èª¤";
      
      const r = String(reason).toUpperCase();
      
      if (r.includes("TIMEOUT")) {
        return `<b>â±ï¸ é€£ç·šé€¾æ™‚</b><br><span style="color:#666">ä¼ºæœå™¨å›æ‡‰è¶…é 30 ç§’ï¼Œå¯èƒ½è² è¼‰éé«˜ã€‚</span>`;
      }
      if (r.includes("FETCH_ERROR")) {
        return `<b>ğŸš« é€£ç·šå¤±æ•— (Fetch Error)</b><br><span style="color:#666">Google ç„¡æ³•å»ºç«‹é€£ç·šï¼Œå¯èƒ½è¢«é˜²ç«ç‰†é˜»æ“‹ã€‚</span>`;
      }
      if (r.includes("SSL")) {
        return `<b>ğŸ”’ SSL æ†‘è­‰éŒ¯èª¤</b><br><span style="color:#666">æ†‘è­‰éæœŸæˆ–ä¸å®‰å…¨ (Https é©—è­‰å¤±æ•—)ã€‚</span>`;
      }
      if (r.includes("DNS")) {
        return `<b>ğŸŒ DNS è§£æå¤±æ•—</b><br><span style="color:#666">æ‰¾ä¸åˆ°è©²ç¶²åŸŸçš„ä¸»æ©Ÿ IPã€‚</span>`;
      }
      if (r.includes("KEYWORD")) {
        return `<b>âš ï¸ é—œéµå­—éŒ¯èª¤</b><br><span style="color:#666">ç¶²é å…§å®¹åŒ…å«éŒ¯èª¤ç‰‡èª (å¦‚: 404 Not Found)ã€‚</span>`;
      }
      if (r.includes("HTTP_")) {
        return `<b>âŒ HTTP éŒ¯èª¤ ${r.split('_')[1]}</b><br><span style="color:#666">ä¼ºæœå™¨å›å‚³ç•°å¸¸ç‹€æ…‹ç¢¼ã€‚</span>`;
      }
      
      return escapeHtml(reason); // è‹¥ç„¡åŒ¹é…å‰‡é¡¯ç¤ºåŸå§‹æ–‡å­—
    }

    function escapeHtml(s) {
      return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    // äº‹ä»¶
    $("refresh").addEventListener("click", load);
    $("q").addEventListener("input", () => render(allItems));
    
    // é»æ“Šå¤–éƒ¨é—œé–‰ popover
    document.addEventListener('click', (e) => {
      if (!e.target.closest('summary')) {
        document.querySelectorAll('details[open]').forEach(d => {
          if (!e.target.closest('.error-popover')) d.removeAttribute('open');
        });
      }
    });

    // å•Ÿå‹•æª¢æ¸¬
    checkAccess();
  </script>
</body>
</html>
