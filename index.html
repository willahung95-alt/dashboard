<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow">
  <title>ç¶²ç«™æœå‹™ç›£æ§ä¸­å¿ƒ</title>
  <style>
    /* --- åŸºç¤è¨­å®š (ç¶­æŒä¸è®Š) --- */
    :root {
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --primary: #2563eb;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --danger-bg: #fee2e2;
      --danger-text: #991b1b;
      --unknown-bg: #f3f4f6;
      --unknown-text: #374151;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      /* é»æ“Šå¤–éƒ¨é—œé–‰ popover éœ€è¦ */
      min-height: 100vh;
    }

    /* --- ç‰ˆé¢é…ç½® (ç¶­æŒä¸è®Š) --- */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
    }
    h1 {
      margin: 0; font-size: 24px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 10px;
    }
    h1::before {
      content: ''; display: block; width: 6px; height: 24px; background: var(--primary); border-radius: 4px;
    }
    .last-update {
      font-size: 13px; color: var(--text-sub); background: #fff; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
    }

    /* --- ç‹€æ…‹æ¦‚è¦½å¡ç‰‡ (ç¶­æŒä¸è®Š) --- */
    .dashboard-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;
    }
    .card {
      background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); display: flex; flex-direction: column;
    }
    .card-label { font-size: 14px; color: var(--text-sub); margin-bottom: 8px; }
    .card-value { font-size: 32px; font-weight: 700; color: var(--text-main); }
    .card.up-card { border-left: 4px solid #10b981; }
    .card.down-card { border-left: 4px solid #ef4444; }
    .card.total-card { border-left: 4px solid #6366f1; }

    /* --- å·¥å…·åˆ— (ç¶­æŒä¸è®Š) --- */
    .toolbar { display: flex; gap: 12px; margin-bottom: 16px; }
    .search-input {
      flex: 1; padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s;
    }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .btn-refresh {
      padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-sub); transition: all 0.2s;
    }
    .btn-refresh:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }

    /* --- è¡¨æ ¼æ¨£å¼ (å¾®èª¿) --- */
    .table-container {
      background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); overflow-x: auto;
      padding-bottom: 50px; /* é ç•™ç©ºé–“çµ¦ popoverï¼Œé¿å…è¢«æˆªæ–· */
    }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    thead { background: #f9fafb; border-bottom: 1px solid var(--border); }
    th {
      text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em;
    }
    td {
      padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: #f9fafb; }

    /* --- ç‹€æ…‹æ¨™ç±¤ Pill (ç¶­æŒä¸è®Š) --- */
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }
    .badge.up { background: var(--success-bg); color: var(--success-text); }
    .badge.down { background: var(--danger-bg); color: var(--danger-text); }
    .badge.unknown { background: var(--unknown-bg); color: var(--unknown-text); }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background-color: currentColor; }

    /* --- é€£çµèˆ‡å…¶ä»–æ–‡å­— (ç¶­æŒä¸è®Š) --- */
    a.link { color: var(--primary); text-decoration: none; font-weight: 500; }
    a.link:hover { text-decoration: underline; }
    .text-sm { font-size: 12px; color: var(--text-sub); }
    .text-code { font-family: monospace; font-size: 13px; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }

    /* ====== æ–°å¢ï¼šäº’å‹•å¼éŒ¯èª¤è¨Šæ¯æ¨£å¼ ====== */
    /* è®“ TD æˆç‚ºå®šä½é» */
    td.col-reason { position: relative; text-align: center; }
    
    /* ä½¿ç”¨ HTML5 details/summary å¯¦ä½œ popover */
    .error-details { display: inline-block; }
    /* éš±è—é è¨­ä¸‰è§’å½¢ marker */
    .error-details summary::-webkit-details-marker { display: none; }
    .error-details summary { list-style: none; }
    
    /* Icon æŒ‰éˆ•æ¨£å¼ */
    .btn-info-toggle {
        cursor: pointer;
        font-size: 18px;
        color: var(--danger-text);
        background: var(--danger-bg);
        width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }
    .btn-info-toggle:hover { background: #fee2e2; transform: scale(1.1); }
    
    /* å½ˆå‡ºè¦–çª—æ¨£å¼ (Popover) */
    .error-popover {
        position: absolute;
        right: 10px; /* é å³å°é½Š */
        top: 50px;   /* Icon ä¸‹æ–¹ */
        z-index: 999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        width: 280px; /* å›ºå®šå¯¬åº¦ï¼Œé¿å…å¤ªå¯¬ */
        background: #fff;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        text-align: left;
        animation: popIn 0.2s ease-out;
    }

    /* å½ˆå‡ºå‹•ç•« */
    @keyframes popIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .popover-title { font-weight: 700; font-size: 14px; margin-bottom: 8px; color: var(--danger-text); display: flex; align-items: center; gap:6px; }
    .err-msg-full { 
      color: var(--text-main); font-size: 13px; line-height: 1.5; 
      word-break: break-word; /* å¼·åˆ¶é•·å–®å­—æ›è¡Œ */
      white-space: pre-wrap;  /* ä¿ç•™æ›è¡Œæ ¼å¼ */
    }

    /* --- Loading å‹•ç•« (ç¶­æŒä¸è®Š) --- */
    .loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px); transition: opacity 0.3s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div id="loader" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <header>
      <h1>ç¶²ç«™æœå‹™ç›£æ§ä¸­å¿ƒ</h1>
      <div class="last-update" id="lastUpdateDisplay">
        <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%; box-shadow:0 0 4px #10b981;"></span>
        ç­‰å¾…åŒæ­¥ä¸­...
      </div>
    </header>

    <div class="dashboard-grid">
      <div class="card total-card">
        <div class="card-label">ç›£æ§ç¸½æ•¸</div>
        <div class="card-value" id="val-total">-</div>
      </div>
      <div class="card up-card">
        <div class="card-label">æœå‹™æ­£å¸¸ (UP)</div>
        <div class="card-value" style="color: #059669;" id="val-up">-</div>
      </div>
      <div class="card down-card">
        <div class="card-label">æœå‹™ç•°å¸¸ (DOWN)</div>
        <div class="card-value" style="color: #dc2626;" id="val-down">-</div>
      </div>
    </div>

    <div class="toolbar">
      <input id="q" class="search-input" placeholder="ğŸ” æœå°‹å®¢æˆ¶åç¨±æˆ–ç¶²å€..." />
      <button id="refresh" class="btn-refresh">âŸ³ é‡æ–°æ•´ç†</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">ç³»çµ±ç‹€æ…‹</th>
            <th style="width:280px;">å®¢æˆ¶åç¨±</th>
            <th>ç¶²å€é€£çµ</th>
            <th style="width:100px;">HTTP</th>
            <th style="width:100px;">å»¶é²</th>
            <th style="width:180px;">æœ€å¾Œæª¢æŸ¥</th>
            <th style="width:90px; text-align:center;">ç‹€æ…‹èªªæ˜</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
	// ç°¡æ˜“å¯†ç¢¼é©—è­‰
	const ACCESS_PASSWORD = "oitc16088678"; // è«‹è‡ªè¡Œè¨­å®š
	const userEntry = prompt("æ­¤ç‚ºå…§éƒ¨ç›£æ§ç³»çµ±ï¼Œè«‹è¼¸å…¥å­˜å–å£ä»¤ï¼š");

	if (userEntry !== ACCESS_PASSWORD) {
		alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–ã€‚");
		document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>ç„¡æ¬Šé™æŸ¥çœ‹æ­¤é é¢</h1>";
		window.stop(); // åœæ­¢å¾ŒçºŒè¼‰å…¥
	}
    // ======= CONFIG (è«‹å¡«å…¥æ‚¨çš„åƒæ•¸) =======
    // è«‹å°‡æ‚¨çš„ GAS ç¶²å€èˆ‡ TOKEN å¡«å¯«æ–¼æ­¤
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxZsTFYOsMhRuStkKOM_IOui4suN2jXsQYWIObka0mnRVynuscYHj1Z-0bv9_vJTntm/exec"; 
    const TOKEN = "v1_2c8c6f3a8c1d4f11b7f5a9c0d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0";
    // -------------------------------------

    const $ = (id) => document.getElementById(id);
    let allItems = [];

    // ç‹€æ…‹æ¨™ç±¤æ¨£å¼
    function getBadgeHtml(status){
      if (status === "UP") 
        return `<span class="badge up"><span class="badge-dot"></span>æ­£å¸¸é‹ä½œ</span>`;
      if (status === "DOWN") 
        return `<span class="badge down"><span class="badge-dot"></span>ç•°å¸¸ä¸­æ–·</span>`;
      return `<span class="badge unknown"><span class="badge-dot"></span>æª¢æŸ¥ä¸­</span>`;
    }

    function render(items){
      const q = ($("q").value || "").trim().toLowerCase();
      const filtered = items.filter(it => {
        if (!q) return true;
        return (it.customer || "").toLowerCase().includes(q) || (it.url || "").toLowerCase().includes(q);
      });

      const tbody = $("tbody");
      tbody.innerHTML = "";

      if(filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color:#999;">æŸ¥ç„¡ç›¸é—œè³‡æ–™</td></tr>`;
      }

      filtered.forEach((it, index) => {
        const tr = document.createElement("tr");

        // ç‹€æ…‹
        const statusTd = document.createElement("td");
        statusTd.innerHTML = getBadgeHtml(it.status);
        tr.appendChild(statusTd);

        // å®¢æˆ¶
        const custTd = document.createElement("td");
        custTd.style.fontWeight = "600";
        custTd.textContent = it.customer || "(æœªå‘½å)";
        tr.appendChild(custTd);

        // ç¶²å€
        const urlTd = document.createElement("td");
        const a = document.createElement("a");
        a.href = it.url; a.className = "link"; a.target = "_blank"; a.rel = "noopener noreferrer";
        a.textContent = it.url;
        urlTd.appendChild(a);
        tr.appendChild(urlTd);

        // HTTP Code
        const codeTd = document.createElement("td");
        codeTd.innerHTML = it.httpCode ? `<span class="text-code">${it.httpCode}</span>` : "-";
        tr.appendChild(codeTd);

        // å»¶é²
        const latTd = document.createElement("td");
        latTd.className = "text-sm";
        latTd.textContent = it.latencyMs ? `${it.latencyMs} ms` : "-";
        tr.appendChild(latTd);

        // æ™‚é–“
        const checkedTd = document.createElement("td");
        checkedTd.className = "text-sm";
        checkedTd.innerHTML = `<div>${it.checkedAt || ""}</div>`;
        tr.appendChild(checkedTd);

        // ä¿®æ”¹é» 3: äº’å‹•å¼åŸå› æ¬„ä½
        const reasonTd = document.createElement("td");
        reasonTd.className = "col-reason"; // åŠ å…¥ class ä»¥ä¾¿ CSS å®šä½

        if (it.status === "DOWN") {
             const reasonText = escapeHtml(it.reason || "æœªçŸ¥éŒ¯èª¤");
             // ä½¿ç”¨ HTML5 details/summary å¯¦ä½œ Popover æ•ˆæœï¼Œä¸ä½”ç”¨è¡¨æ ¼ç©ºé–“
             reasonTd.innerHTML = `
                <details class="error-details" id="details-${index}">
                    <summary class="btn-info-toggle" title="é»æ“ŠæŸ¥çœ‹è©³ç´°åŸå› ">â„¹ï¸</summary>
                    <div class="error-popover">
                        <div class="popover-title">âš ï¸ ç•°å¸¸è©³ç´°è³‡è¨Š</div>
                        <div class="err-msg-full">${reasonText}</div>
                    </div>
                </details>
             `;
        } else {
             reasonTd.innerHTML = `<span class="text-sm" style="color:#9ca3af">OK</span>`;
        }
        tr.appendChild(reasonTd);

        tbody.appendChild(tr);
      });

      updateStats(filtered);
    }

    // ... (updateStats, escapeHtml, load ç­‰å‡½æ•¸ä¿æŒä¸è®Š)
    function updateStats(items) {
      const up = items.filter(x => x.status === "UP").length;
      const down = items.filter(x => x.status === "DOWN").length;
      $("val-total").textContent = items.length;
      $("val-up").textContent = up;
      $("val-down").textContent = down;
    }

    function escapeHtml(s){
      return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    async function load(){
      if(allItems.length === 0) $("loader").classList.remove("hidden");
      $("lastUpdateDisplay").innerHTML = `âŸ³ æ›´æ–°ä¸­...`;
      try {
        const url = `${GAS_WEB_APP_URL}?token=${encodeURIComponent(TOKEN)}`;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        if (!data.ok){ alert(`è¼‰å…¥å¤±æ•—ï¼š${data.error || "unknown"}`); return; }
        allItems = data.items || [];
        render(allItems);
        const now = new Date();
        $("lastUpdateDisplay").innerHTML = `<span style="color:#059669">âœ”</span> æœ€å¾Œæ›´æ–°ï¼š${now.toLocaleTimeString('zh-TW', { hour12: false })}`;
      } catch(e) {
        console.error(e); $("lastUpdateDisplay").innerHTML = `<span style="color:#dc2626">âœ–</span> é€£ç·šéŒ¯èª¤`;
      } finally {
        $("loader").classList.add("hidden");
      }
    }

    $("refresh").addEventListener("click", load);
    $("q").addEventListener("input", () => render(allItems));

    // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚ï¼Œé—œé–‰æ‰€æœ‰å·²é–‹å•Ÿçš„ error popover
    document.addEventListener('click', function(e) {
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯ summary (icon) æœ¬èº«æˆ–å…¶å…§éƒ¨
        if (!e.target.closest('summary')) {
            const openDetails = document.querySelectorAll('details[open]');
            openDetails.forEach(detail => {
                // å¦‚æœé»æ“Šçš„ä¹Ÿä¸æ˜¯ popover å…§å®¹æœ¬èº«ï¼Œå°±é—œé–‰å®ƒ
                if (!e.target.closest('.error-popover')) {
                    detail.removeAttribute('open');
                }
            });
        }
    });

    load();
    setInterval(load, 60 * 1000);
  </script>
</body>
</html>
